<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Inpod Fans Product Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- jsPDF for warranty PDF download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg-gradient-from: #0f172a;
      --bg-gradient-to:   #1f2937;
      --card-bg: #ffffff;
      --accent:  #f97316;
      --accent-soft: #ffedd5;
      --accent-dark: #ea580c;
      --text-main: #0f172a;
      --text-muted: #64748b;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: radial-gradient(circle at top, var(--bg-gradient-to), var(--bg-gradient-from));
      min-height: 100vh;
      padding: 20px;
      color: var(--text-main);
    }
    .container { max-width: 640px; margin: 0 auto; }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .logo-wrapper img {
      width: 180px;
      max-width: 70%;
      height: auto;
    }
    .lang-switch {
      display: flex;
      gap: 6px;
      background: rgba(15,23,42,0.5);
      padding: 4px;
      border-radius: 999px;
    }
    .lang-btn {
      border: none;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: #e5e7eb;
    }
    .lang-btn.active {
      background: #f97316;
      color: #111827;
      font-weight: 600;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 22px;
      font-size: 24px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    }

    .product-info { background: var(--accent-soft); border-left: 4px solid var(--accent); }
    .product-info div { padding: 6px 0; color: var(--text-main); font-size: 14px; }
    .product-info b { min-width: 150px; display: inline-block; }

    .form-group { margin-bottom: 14px; }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      color: #111827;
      font-size: 13px;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1.8px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: 0.2s;
      font-family: inherit;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(249,115,22,0.25);
    }

    .btn {
      padding: 11px;
      border: none;
      border-radius: 999px;
      width: 100%;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: #111827;
      transition: 0.2s;
      margin-top: 6px;
    }
    .btn:hover:not(:disabled) { background: var(--accent-dark); color:#fff; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .alert {
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .alert-error { background:#fee2e2; color:#b91c1c; }
    .alert-info  { background:#dbeafe; color:#1e40af; }

    .hidden { display:none; }

    .loading { text-align:center;padding:30px 16px;color:white; }
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%; width: 32px; height: 32px;
      animation: spin 1s linear infinite; margin: 0 auto 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }

    .success-page { text-align:center; padding:26px 18px; }
    .success-icon { font-size:52px; margin-bottom:14px; }
    .success-details {
      background:#f9fafb;
      padding:16px;
      border-radius:12px;
      margin-top:14px;
      text-align:left;
      font-size:14px;
    }
    .success-details div { padding:5px 0; color:#111827; }
    .success-actions {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
  </style>

  <!-- MSG91 Widget (Default UI) -->
  <script>
    // Apps Script web app URL
    const API_BASE =
      "https://script.google.com/macros/s/AKfycbyhC7ivoWvPm1hYo2VDr9mheEMBkmVFHrIHsxYpDNDH0KNkVNRvBN2DENMW4uWriymr/exec";

    let registrationFormData = null;
    let currentLang = 'en';

    const T = {
      en: {
        title: "Product Registration",
        dealer: "Dealer Name",
        dealerOther: "Other Dealer Name",
        customer: "Customer Name",
        purchase: "Purchase Date",
        phone: "Mobile Number",
        verifyBtn: "Verify OTP & Register",
        loadingProduct: "Loading product...",
        errorNoSN: "Missing serial number.",
        errorFillAll: "Please fill all required fields.",
        errorPhone: "Enter a valid 10-digit mobile number.",
        otpNotReady: "OTP system not ready. Try again.",
        otpOpen: "Opening OTP...",
        submitting: "Submitting...",
        successTitle: "Registration Successful!",
        successText: "Your product has been successfully registered.",
        pdfBtn: "Download Warranty PDF",
        langEn: "EN",
        langHi: "HI",
        dealerPlaceholder: "Select Dealer"
      },
      hi: {
        title: "उत्पाद पंजीकरण",
        dealer: "डीलर का नाम",
        dealerOther: "अन्य डीलर का नाम",
        customer: "ग्राहक का नाम",
        purchase: "खरीद की तारीख",
        phone: "मोबाइल नंबर",
        verifyBtn: "ओटीपी सत्यापित करें व पंजीकरण करें",
        loadingProduct: "उत्पाद लोड हो रहा है...",
        errorNoSN: "सीरियल नंबर नहीं मिला।",
        errorFillAll: "कृपया सभी अनिवार्य जानकारी भरें।",
        errorPhone: "कृपया 10 अंकों का सही मोबाइल नंबर दर्ज करें।",
        otpNotReady: "ओटीपी सिस्टम तैयार नहीं है, दोबारा प्रयास करें।",
        otpOpen: "ओटीपी खोला जा रहा है...",
        submitting: "सबमिट हो रहा है...",
        successTitle: "पंजीकरण सफल!",
        successText: "आपका उत्पाद सफलतापूर्वक पंजीकृत हो गया है।",
        pdfBtn: "वारंटी PDF डाउनलोड करें",
        langEn: "अं",
        langHi: "हि",
        dealerPlaceholder: "डीलर चुनें"
      }
    };

    function t(key) {
      return (T[currentLang] && T[currentLang][key]) || T.en[key] || key;
    }

    function updateLangUI() {
      document.getElementById("title-text").textContent = t('title');
      document.querySelector("label[for='dealer-select']").textContent        = t('dealer') + " *";
      document.querySelector("label[for='dealer-other-input']").textContent   = t('dealerOther') + " *";
      document.querySelector("label[for='customer-input']").textContent       = t('customer') + " *";
      document.querySelector("label[for='purchase-input']").textContent       = t('purchase') + " *";
      document.querySelector("label[for='phone-input']").textContent          = t('phone') + " *";
      document.getElementById("verify-btn").textContent                       = t('verifyBtn');
      document.getElementById("loading-text").textContent                     = t('loadingProduct');
      document.getElementById("lang-en").textContent                          = T.en.langEn;
      document.getElementById("lang-hi").textContent                          = T.en.langHi;
    }

    // MSG91 configuration
    var configuration = {
      widgetId:  "356c6a614a59393139323835",
      tokenAuth: "479874Tz6YZockSUbu69273d6bP1",
      identifier: "",
      exposeMethods: false, // default UI handles OTP screen

      success: function(data) {
        console.log("MSG91 success:", data);

        var accessToken =
          data.accessToken ||
          data["access-token"] ||
          data.token ||
          (data.response &&
           (data.response.accessToken || data.response["access-token"] || data.response.token)) ||
          data.message;

        if (!accessToken) {
          alert("Could not read OTP token.");
          const btn = document.getElementById("verify-btn");
          btn.disabled = false;
          btn.textContent = t('verifyBtn');
          return;
        }

        completeRegistration(accessToken);
      },

      failure: function(error) {
        console.log("MSG91 failure:", error);
        alert("OTP verification failed.");
        const btn = document.getElementById("verify-btn");
        btn.disabled = false;
        btn.textContent = t('verifyBtn');
      }
    };

    // Load MSG91 JS
    (function loadOtpScript(urls){
      let i=0;
      function attempt(){
        let s=document.createElement("script");
        s.src=urls[i];
        s.async=true;
        s.onload=()=>console.log("Loaded:", urls[i]);
        s.onerror=()=>{ i++; if(i<urls.length) attempt(); };
        document.head.appendChild(s);
      }
      attempt();
    })([
      "https://verify.msg91.com/otp-provider.js",
      "https://verify.phone91.com/otp-provider.js"
    ]);
  </script>
</head>

<body>
  <div class="container">

    <div class="top-bar">
      <div class="logo-wrapper">
        <img src="https://inpodfans.com/images/logo/logo.svg" alt="Inpod Fans Logo">
      </div>
      <div class="lang-switch">
        <button id="lang-en" class="lang-btn active">EN</button>
        <button id="lang-hi" class="lang-btn">HI</button>
      </div>
    </div>

    <h1 id="title-text">Product Registration</h1>

    <div id="loading-state" class="loading hidden">
      <div class="spinner"></div>
      <p id="loading-text">Loading product...</p>
    </div>

    <div id="error-state" class="hidden">
      <div class="card">
        <div class="alert alert-error" id="error-message"></div>
      </div>
    </div>

    <div id="main-content" class="hidden">
      <div id="product-info" class="card product-info"></div>

      <div class="card">
        <form onsubmit="return false;">

          <!-- Dealer dropdown from backend -->
          <div class="form-group" id="dealer-select-group">
            <label for="dealer-select">Dealer Name *</label>
            <select id="dealer-select">
              <option value="">Loading dealers...</option>
            </select>
          </div>

          <div class="form-group hidden" id="dealer-other-group">
            <label for="dealer-other-input">Other Dealer Name *</label>
            <input id="dealer-other-input">
          </div>

          <div class="form-group">
            <label for="customer-input">Customer Name *</label>
            <input id="customer-input" required>
          </div>

          <div class="form-group">
            <label for="purchase-input">Purchase Date *</label>
            <input type="date" id="purchase-input" required>
          </div>

          <div class="form-group">
            <label for="phone-input">Mobile Number *</label>
            <input id="phone-input" placeholder="9988776655" required>
          </div>

          <div id="client-error" class="alert alert-error hidden"></div>
          <div id="client-info"  class="alert alert-info hidden"></div>

          <button type="button" id="verify-btn" class="btn">
            Verify OTP & Register
          </button>

        </form>
      </div>
    </div>

  </div>

  <script>
    function showError(msg){
      const e=document.getElementById("client-error");
      e.textContent=msg;
      e.classList.remove("hidden");
      document.getElementById("client-info").classList.add("hidden");
    }

    function showInfo(msg){
      const e=document.getElementById("client-info");
      e.textContent=msg;
      e.classList.remove("hidden");
      document.getElementById("client-error").classList.add("hidden");
    }

    function hideMessages(){
      document.getElementById("client-error").classList.add("hidden");
      document.getElementById("client-info").classList.add("hidden");
    }

    function getSerial(){
      return new URLSearchParams(window.location.search).get("sn") || "";
    }

    // Language switching
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("lang-en").addEventListener("click", () => {
        currentLang = 'en';
        document.getElementById("lang-en").classList.add("active");
        document.getElementById("lang-hi").classList.remove("active");
        updateLangUI();
      });
      document.getElementById("lang-hi").addEventListener("click", () => {
        currentLang = 'hi';
        document.getElementById("lang-hi").classList.add("active");
        document.getElementById("lang-en").classList.remove("active");
        updateLangUI();
      });
      updateLangUI();
    });

    // Load dealers from backend
    async function loadDealers() {
      const select = document.getElementById("dealer-select");
      const dealerSelectGroup = document.getElementById("dealer-select-group");
      const dealerOtherGroup  = document.getElementById("dealer-other-group");

      try {
        const res = await fetch(`${API_BASE}?dealers=1`);
        const result = await res.json();

        if (!result.success || !Array.isArray(result.dealers) || result.dealers.length === 0) {
          // fallback: hide dropdown, use free-text only
          dealerSelectGroup.classList.add("hidden");
          dealerOtherGroup.classList.remove("hidden");
          return;
        }

        select.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = t('dealerPlaceholder');
        select.appendChild(placeholder);

        result.dealers.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });

        const optOther = document.createElement("option");
        optOther.value = "OTHER";
        optOther.textContent = "Other";
        select.appendChild(optOther);

        select.addEventListener("change", () => {
          if (select.value === "OTHER") {
            dealerOtherGroup.classList.remove("hidden");
          } else {
            dealerOtherGroup.classList.add("hidden");
          }
        });

      } catch (e) {
        console.error("Error loading dealers:", e);
        dealerSelectGroup.classList.add("hidden");
        dealerOtherGroup.classList.remove("hidden");
      }
    }

    // Load product
    document.addEventListener("DOMContentLoaded", async ()=>{
      await loadDealers();

      const sn = getSerial();
      const loader = document.getElementById("loading-state");
      loader.classList.remove("hidden");

      if(!sn){
        loader.classList.add("hidden");
        document.getElementById("error-state").classList.remove("hidden");
        document.getElementById("error-message").textContent=t('errorNoSN');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}?sn=${encodeURIComponent(sn)}`);
        const data = await res.json();
        loader.classList.add("hidden");

        if(data.success && data.product){
          window.currentSerialNo = sn;
          const p = data.product;

          document.getElementById("product-info").innerHTML = `
            <div><b>Serial No.:</b> ${p.serialNo || '-'}</div>
            <div><b>Model Name:</b> ${p.modelName || '-'}</div>
            <div><b>Manufacturing Date:</b> ${p.manufacturingDate || '-'}</div>
          `;
          document.getElementById("main-content").classList.remove("hidden");
        } else {
          document.getElementById("error-state").classList.remove("hidden");
          document.getElementById("error-message").textContent=data.msg || "Product not found.";
        }
      } catch {
        loader.classList.add("hidden");
        document.getElementById("error-state").classList.remove("hidden");
        document.getElementById("error-message").textContent="Error loading product.";
      }
    });

    // OTP Button
    document.getElementById("verify-btn").addEventListener("click", () => {
      const sn = window.currentSerialNo;

      const dealerSelectGroup = document.getElementById("dealer-select-group");
      const dealerSelect      = document.getElementById("dealer-select");
      const dealerOtherGroup  = document.getElementById("dealer-other-group");
      const dealerOtherInput  = document.getElementById("dealer-other-input");

      let dealer = "";
      if (!dealerSelectGroup.classList.contains("hidden") && dealerSelect) {
        dealer = dealerSelect.value;
        if (dealer === "OTHER") {
          dealer = dealerOtherInput.value.trim();
        }
      } else {
        dealer = dealerOtherInput.value.trim();
      }

      const customer = document.getElementById("customer-input").value.trim();
      const purchase = document.getElementById("purchase-input").value.trim();
      let phone      = document.getElementById("phone-input").value.trim();

      if(!sn || !dealer || !customer || !purchase || !phone){
        showError(t('errorFillAll'));
        return;
      }

      phone = phone.replace(/\D/g,"");

      if(phone.length === 10){
        configuration.identifier = "91" + phone;
      } else if(phone.length === 12 && phone.startsWith("91")){
        configuration.identifier = phone;
        phone = phone.slice(-10);
      } else {
        showError(t('errorPhone'));
        return;
      }

      registrationFormData = { sn, dealer, customer, purchase, phone };

      hideMessages();
      const btn=document.getElementById("verify-btn");
      btn.disabled=true;
      btn.textContent=t('otpOpen');

      if(typeof window.initSendOTP === "function"){
        window.initSendOTP(configuration);
      } else {
        showError(t('otpNotReady'));
        btn.disabled=false;
        btn.textContent=t('verifyBtn');
      }
    });

    // After MSG91 OTP success
    async function completeRegistration(accessToken){
      const btn=document.getElementById("verify-btn");
      btn.textContent=t('submitting');

      try {
        const response = await fetch(API_BASE, {
          method: "POST",
          headers: { "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify({
            action: "saveRegistration",
            data: Object.assign({}, registrationFormData, { otp_token: accessToken })
          })
        });

        const result = await response.json();
        console.log("saveRegistration:", result);

        if(!result.success){
          throw new Error(result.msg);
        }

        showSuccessPage(result);
        triggerWarrantyPdf(result);

      } catch(err){
        btn.disabled=false;
        btn.textContent=t('verifyBtn');
        showError("Error: " + err.message);
      }
    }

    function showSuccessPage(r){
      document.body.innerHTML = `
        <div class="container">
          <div class="top-bar">
            <div class="logo-wrapper">
              <img src="https://inpodfans.com/images/logo/logo.svg" alt="Inpod Fans Logo">
            </div>
          </div>
          <div class="card success-page">
            <div class="success-icon">✅</div>
            <h2>${t('successTitle')}</h2>
            <p style="color:#6b7280;margin-bottom:14px;">
              ${t('successText')}
            </p>
            <div class="success-details">
              <div><b>Serial No.:</b> ${r.sn}</div>
              <div><b>Model:</b> ${r.model || '-'}</div>
              <div><b>Purchase Date:</b> ${r.purchaseDDMMYYYY}</div>
              <div><b>Warranty Period:</b> 24 months from date of purchase</div>
              <div><b>Warranty Ends On:</b> ${r.warrantyExpiryDDMMYYYY || '-'}</div>
            </div>
            <div class="success-actions">
              <button id="pdf-btn" class="btn">${t('pdfBtn')}</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('pdf-btn').addEventListener('click', () => {
        triggerWarrantyPdf(r);
      });
    }

    // Warranty PDF via jsPDF – with logo & 24-month info
    function triggerWarrantyPdf(r) {
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert("PDF library not loaded.");
        return;
      }

      const doc = new jsPDF('p', 'mm', 'a4');
      const pageWidth = doc.internal.pageSize.getWidth();

      const logoUrl = "https://inpodfans.com/images/logo/logo.svg";

      function drawContent() {
        // Header bar
        doc.setFillColor(15, 23, 42);
        doc.rect(0, 0, pageWidth, 24, 'F');

        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text("Inpod Fans – Warranty Certificate", pageWidth / 2, 16, { align: "center" });

        // Body
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        let y = 36;

        doc.setFont(undefined, "bold");
        doc.text("Customer & Product Details", 20, y);
        doc.setFont(undefined, "normal");
        y += 8;

        doc.text(`Serial No. : ${r.sn}`, 20, y); y += 7;
        doc.text(`Model      : ${r.model || "-"}`, 20, y); y += 7;
        doc.text(`Purchase   : ${r.purchaseDDMMYYYY}`, 20, y); y += 7;
        if (r.warrantyExpiryDDMMYYYY) {
          doc.text(`Warranty   : 24 months from purchase`, 20, y); y += 7;
          doc.text(`Valid Upto : ${r.warrantyExpiryDDMMYYYY}`, 20, y); y += 10;
        } else {
          doc.text(`Warranty   : 24 months from date of purchase`, 20, y); 
          y += 10;
        }

        doc.setFont(undefined, "bold");
        doc.text("Warranty Terms (Summary)", 20, y);
        y += 7;
        doc.setFont(undefined, "normal");
        doc.setFontSize(10);

        const terms = [
          "• Warranty is valid for 24 months from the date of purchase as per the invoice.",
          "• Warranty covers manufacturing defects in materials and workmanship only.",
          "• Damage due to incorrect installation, mishandling, or misuse is not covered.",
          "• For service, please contact authorised Inpod Fans service centres only.",
          "• Warranty is valid only with a valid proof of purchase / invoice."
        ];

        terms.forEach(line => {
          const split = doc.splitTextToSize(line, pageWidth - 40);
          doc.text(split, 20, y);
          y += split.length * 5 + 2;
        });

        y += 6;
        doc.setFontSize(9);
        doc.setTextColor(100, 116, 139);
        doc.text("This is a computer generated warranty document and does not require a signature.", 20, y);

        const fileName = `Inpod_Warranty_${r.sn}.pdf`;
        doc.save(fileName);
      }

      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = function () {
        try {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);

          const imgData = canvas.toDataURL("image/png");
          doc.addImage(imgData, "PNG", 12, 6, 24, 12);
        } catch (e) {
          console.warn("Logo draw failed, continuing without image:", e);
        }
        drawContent();
      };
      img.onerror = function () {
        drawContent();
      };
      img.src = logoUrl;
    }
  </script>
</body>
</html>
